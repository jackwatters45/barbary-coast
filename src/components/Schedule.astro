---
import type { UlaxGameSerialized } from "../lib/ulax";
import { parseLocalDate } from "../lib/date";

interface Event {
  date: string;
  time: string;
  type: "game" | "practice" | "scrimmage" | "tournament";
  opponent?: string;
  name?: string;
  location: string;
  locationUrl?: string;
}

function getMapsUrl(location: string): string {
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
}

interface Props {
  events?: Event[];
  ulaxGames?: UlaxGameSerialized[];
  limit?: number;
  barbaryCoastOnly?: boolean;
  upcomingOnly?: boolean;
}

const {
  events = [],
  ulaxGames = [],
  limit,
  barbaryCoastOnly = false,
  upcomingOnly = false,
} = Astro.props;

let filteredUlaxGames = barbaryCoastOnly ? ulaxGames.filter((g) => g.isBarbaryCoast) : ulaxGames;

if (upcomingOnly) {
  filteredUlaxGames = filteredUlaxGames.filter((g) => g.homeScore === null && g.awayScore === null);
}

const filteredEvents = upcomingOnly
  ? events.filter((e) => new Date(e.date) >= new Date(new Date().toDateString()))
  : events;

type ScheduleItem = { kind: "ulax"; data: UlaxGameSerialized } | { kind: "event"; data: Event };

const allItems: ScheduleItem[] = [
  ...filteredUlaxGames.map((g) => ({ kind: "ulax" as const, data: g })),
  ...filteredEvents.map((e) => ({ kind: "event" as const, data: e })),
].sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime());

const displayItems = limit ? allItems.slice(0, limit) : allItems;

function isPlayoffs(game: UlaxGameSerialized): boolean {
  return game.gameType === "playoff" || game.gameType === "championship";
}

function isTBD(game: UlaxGameSerialized): boolean {
  return game.awayTeam === "TBD" || game.homeTeam === "TBD";
}

function getOpponent(game: UlaxGameSerialized): string {
  return game.barbaryCoastIsHome ? game.awayTeam : game.homeTeam;
}

function getBarbaryCoastScore(game: UlaxGameSerialized): number | null {
  return game.barbaryCoastIsHome ? game.homeScore : game.awayScore;
}

function getOpponentScore(game: UlaxGameSerialized): number | null {
  return game.barbaryCoastIsHome ? game.awayScore : game.homeScore;
}

function isWin(game: UlaxGameSerialized): boolean | null {
  const bcScore = getBarbaryCoastScore(game);
  const oppScore = getOpponentScore(game);
  if (bcScore === null || oppScore === null) return null;
  return bcScore > oppScore;
}
---

<div class="space-y-3">
  {displayItems.map((item) => {
    if (item.kind === "ulax") {
      const game = item.data;
      const bcScore = getBarbaryCoastScore(game);
      const oppScore = getOpponentScore(game);
      const hasScore = bcScore !== null && oppScore !== null;
      const won = isWin(game);
      const date = parseLocalDate(game.date);

      return (
        <article class="card p-4 sm:p-5">
          <div class="flex items-start gap-4">
            <!-- Date -->
            <div class="flex-shrink-0 text-center w-12 border-r border-border pr-4">
              <span class="block text-2xl font-semibold font-mono text-foreground tabular-nums leading-tight">{String(date.getDate()).padStart(2, "0")}</span>
              <span class="block text-xs text-muted uppercase tracking-wide">{date.toLocaleDateString("en-US", { month: "short" })}</span>
            </div>

            <!-- Details -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class:list={["label", isPlayoffs(game) ? "text-gold" : "text-powder"]}>
                  [{isPlayoffs(game) ? game.typeName.toLowerCase() : "league"}]
                </span>
                <span class="text-sm text-muted font-mono">{game.time}</span>
              </div>
              <div class="flex items-center gap-3 flex-wrap">
                <h3 class="font-medium text-foreground">
                  {isTBD(game) ? game.typeName : `vs ${getOpponent(game)}`}
                </h3>
                {hasScore && (
                  <span class:list={["px-2 py-0.5 text-xs font-mono font-medium", won ? "bg-win/10 text-win" : "bg-loss/10 text-loss"]}>
                    {won ? "W" : "L"} {bcScore}-{oppScore}
                  </span>
                )}
              </div>
              <a href={getMapsUrl(game.field)} target="_blank" rel="noopener" class="text-sm text-muted hover:text-foreground transition-colors">
                {game.field}
              </a>
            </div>
          </div>
        </article>
      );
    } else {
      const event = item.data;
      const date = parseLocalDate(event.date);

      return (
        <article class="card p-4 sm:p-5">
          <div class="flex items-start gap-4">
            <!-- Date -->
            <div class="flex-shrink-0 text-center w-12 border-r border-border pr-4">
              <span class="block text-2xl font-semibold font-mono text-foreground tabular-nums leading-tight">{String(date.getDate()).padStart(2, "0")}</span>
              <span class="block text-xs text-muted uppercase tracking-wide">{date.toLocaleDateString("en-US", { month: "short" })}</span>
            </div>

            <!-- Details -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class:list={["label", event.type === "practice" ? "text-powder" : "text-gold"]}>
                  [{event.type}]
                </span>
                <span class="text-sm text-muted font-mono">{event.time}</span>
              </div>
              <h3 class="font-medium text-foreground">
                {event.name ?? (event.opponent ? `vs ${event.opponent}` : "Practice")}
              </h3>
              <a href={event.locationUrl ?? getMapsUrl(event.location)} target="_blank" rel="noopener" class="text-sm text-muted hover:text-foreground transition-colors">
                {event.location}
              </a>
            </div>
          </div>
        </article>
      );
    }
  })}
</div>
