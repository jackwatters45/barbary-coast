---
import Layout from "../layouts/Layout.astro";
import ScheduleList from "../components/Schedule.astro";
import Standings from "../components/Standings.astro";
import ulaxData from "../data/ulax.json";
import { manualEvents } from "../data/events";
import type { UlaxGameSerialized, UlaxStanding, UlaxAllDataSerialized } from "../lib/ulax";

const data = ulaxData as UlaxAllDataSerialized;
const currentSeasonKey = `${data.currentSeason}-${data.currentYear}`;

// All available seasons, sorted newest first
const seasonKeys = Object.keys(data.seasons).sort((a, b) => {
  const [, yearA] = a.split("-");
  const [, yearB] = b.split("-");
  if (yearA !== yearB) return Number(yearB) - Number(yearA);
  // Within same year: summer > spring > winter
  const order = { summer: 2, spring: 1, winter: 0 };
  const seasonA = a.split("-")[0] as keyof typeof order;
  const seasonB = b.split("-")[0] as keyof typeof order;
  return (order[seasonB] ?? 0) - (order[seasonA] ?? 0);
});

// Prepare data for each season (used by client JS to swap)
const seasonsData = Object.fromEntries(
  seasonKeys.map((key) => {
    const sd = data.seasons[key];
    return [
      key,
      {
        schedule: (sd?.schedule ?? []) as UlaxGameSerialized[],
        standings: (sd?.standings ?? []) as UlaxStanding[],
      },
    ];
  }),
);

const fetchedAt = new Date(data.fetchedAt);

function formatSeasonLabel(key: string): string {
  const [season, year] = key.split("-");
  return `${season.charAt(0).toUpperCase() + season.slice(1)} ${year}`;
}
---

<Layout
  title="Schedule"
  description="Full schedule and standings for Barbary Coast Lacrosse."
>
  <div class="max-w-4xl mx-auto px-6 py-16">
    <!-- Back link -->
    <a href="/" class="subtle-link mb-12 inline-block">‚Üê Back</a>

    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center gap-3 flex-wrap">
        <h1
          class="text-4xl sm:text-5xl font-medium text-foreground tracking-tight"
        >
          Schedule
        </h1>
      </div>

      <!-- Season selector -->
      {seasonKeys.length > 1 && (
        <div class="mt-4 flex gap-2 flex-wrap">
          {seasonKeys.map((key) => (
            <button
              data-season={key}
              class:list={[
                "season-btn px-3 py-1.5 text-sm font-mono transition-colors border",
                key === currentSeasonKey
                  ? "border-powder text-powder bg-powder/10"
                  : "border-border text-muted hover:text-foreground hover:border-foreground/30",
              ]}
            >
              {formatSeasonLabel(key)}
              {key === currentSeasonKey && (
                <span class="ml-1 text-xs opacity-60">current</span>
              )}
            </button>
          ))}
        </div>
      )}
    </header>

    <!-- Games -->
    {seasonKeys.map((key) => (
      <section
        data-season-content={key}
        class:list={["mb-16", key !== currentSeasonKey && "hidden"]}
      >
        <ScheduleList
          ulaxGames={seasonsData[key]?.schedule ?? []}
          events={key === currentSeasonKey ? manualEvents : []}
          barbaryCoastOnly={true}
        />
      </section>
    ))}

    <!-- Standings -->
    {seasonKeys.map((key) => {
      const standings = seasonsData[key]?.standings ?? [];
      return (
        <section
          data-season-standings={key}
          class:list={["mb-16", key !== currentSeasonKey && "hidden"]}
        >
          <h2 class="text-xl font-medium text-foreground mb-6">Standings</h2>
          <Standings standings={standings} />
        </section>
      );
    })}

    <!-- Footer -->
    <footer
      class="flex items-center justify-between pt-8 border-t border-border"
    >
      <p class="text-sm text-subtle">
        Updated {
          fetchedAt.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric",
          })
        }
      </p>
      <p class="text-sm text-subtle">
        Data from <a
          href="https://ulax.org/sanfrancisco/men/"
          target="_blank"
          rel="noopener"
          class="text-powder hover:underline">ulax.org</a
        >
      </p>
    </footer>
  </div>
</Layout>

<script>
  const buttons = document.querySelectorAll<HTMLButtonElement>(".season-btn");
  const contents = document.querySelectorAll<HTMLElement>("[data-season-content]");
  const standings = document.querySelectorAll<HTMLElement>("[data-season-standings]");

  buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const season = btn.dataset.season;
      if (!season) return;

      // Update buttons
      buttons.forEach((b) => {
        const isActive = b.dataset.season === season;
        b.classList.toggle("border-powder", isActive);
        b.classList.toggle("text-powder", isActive);
        b.classList.toggle("bg-powder/10", isActive);
        b.classList.toggle("border-border", !isActive);
        b.classList.toggle("text-muted", !isActive);
      });

      // Show/hide content
      contents.forEach((el) => {
        el.classList.toggle("hidden", el.dataset.seasonContent !== season);
      });
      standings.forEach((el) => {
        el.classList.toggle("hidden", el.dataset.seasonStandings !== season);
      });
    });
  });
</script>
