---
import Layout from "../layouts/Layout.astro";
import ScheduleList from "../components/Schedule.astro";
import Standings from "../components/Standings.astro";
import ulaxData from "../data/ulax.json";
import calendarData from "../data/calendar.json";
import type { CalendarEvent } from "../lib/calendar";
import type { UlaxGameSerialized, UlaxStanding, UlaxAllDataSerialized } from "../lib/ulax";

const data = ulaxData as UlaxAllDataSerialized;
const calEvents = calendarData.events as CalendarEvent[];
const currentSeasonKey = `${data.currentSeason}-${data.currentYear}`;
const currentYear = data.currentYear;

// Current season data
const currentSeason = data.seasons[currentSeasonKey];
const currentSchedule = (currentSeason?.schedule ?? []) as UlaxGameSerialized[];
const currentStandings = (currentSeason?.standings ?? []) as UlaxStanding[];

// Upcoming: unscored ULAX games + future calendar events
const today = new Date(new Date().toDateString());
const upcomingUlaxGames = currentSchedule.filter(
  (g) => g.isBarbaryCoast && g.homeScore === null && g.awayScore === null,
);
const upcomingCalEvents = calEvents.filter((e) => new Date(e.start.slice(0, 10)) >= today);

// Current season results: BC games with scores
const currentResults = currentSchedule.filter(
  (g) => g.isBarbaryCoast && g.homeScore !== null && g.awayScore !== null,
);

// Archive: group past seasons by year (exclude current year)
const seasonOrder = { summer: 2, spring: 1, winter: 0 } as const;

const archiveYears = new Map<
  number,
  { seasonKey: string; schedule: UlaxGameSerialized[]; standings: UlaxStanding[] }[]
>();

for (const [key, sd] of Object.entries(data.seasons)) {
  const [, yearStr] = key.split("-");
  const year = Number(yearStr);
  if (year >= currentYear) continue; // Skip current year

  if (!archiveYears.has(year)) archiveYears.set(year, []);
  archiveYears.get(year)?.push({
    seasonKey: key,
    schedule: (sd?.schedule ?? []) as UlaxGameSerialized[],
    standings: (sd?.standings ?? []) as UlaxStanding[],
  });
}

// Sort years descending, seasons within each year by order
const sortedArchiveYears = [...archiveYears.entries()]
  .sort(([a], [b]) => b - a)
  .map(([year, seasons]) => ({
    year,
    seasons: seasons.sort((a, b) => {
      const sa = a.seasonKey.split("-")[0] as keyof typeof seasonOrder;
      const sb = b.seasonKey.split("-")[0] as keyof typeof seasonOrder;
      return (seasonOrder[sb] ?? 0) - (seasonOrder[sa] ?? 0);
    }),
  }));

// Archive calendar events grouped by year (exclude current year)
const archiveCalByYear = new Map<number, CalendarEvent[]>();
for (const event of calEvents) {
  const eventYear = Number(event.start.slice(0, 4));
  if (eventYear >= currentYear) continue;
  if (!archiveCalByYear.has(eventYear)) archiveCalByYear.set(eventYear, []);
  archiveCalByYear.get(eventYear)?.push(event);
}

const fetchedAt = new Date(data.fetchedAt);

function formatSeasonLabel(key: string): string {
  const [season, year] = key.split("-");
  return `${season.charAt(0).toUpperCase() + season.slice(1)} ${year}`;
}
---

<Layout
  title="Schedule"
  description="Full schedule and standings for Barbary Coast Lacrosse."
>
  <div class="max-w-4xl mx-auto px-6 py-16">
    <!-- Back link -->
    <a href="/" class="subtle-link mb-12 inline-block">&larr; Back</a>

    <!-- Header -->
    <header class="mb-12">
      <h1 class="text-4xl sm:text-5xl font-medium text-foreground tracking-tight">
        Schedule
      </h1>
    </header>

    <!-- A. Upcoming -->
    <section class="mb-16">
      <h2 class="text-xl font-medium text-foreground mb-6">
        <span class="label text-powder mr-2">[upcoming]</span>
      </h2>
      {(upcomingUlaxGames.length > 0 || upcomingCalEvents.length > 0) ? (
        <ScheduleList
          ulaxGames={upcomingUlaxGames}
          calendarEvents={upcomingCalEvents}
          barbaryCoastOnly={true}
        />
      ) : (
        <p class="text-muted text-sm">No upcoming events.</p>
      )}
    </section>

    <!-- B. Current Season Results -->
    {(currentResults.length > 0 || currentStandings.length > 0) && (
      <section class="mb-16">
        <h2 class="text-xl font-medium text-foreground mb-6">
          {formatSeasonLabel(currentSeasonKey)}
        </h2>
        {currentResults.length > 0 && (
          <div class="mb-8">
            <ScheduleList ulaxGames={currentResults} barbaryCoastOnly={true} />
          </div>
        )}
        {currentStandings.length > 0 && (
          <div>
            <h3 class="text-lg font-medium text-foreground mb-4">Standings</h3>
            <Standings standings={currentStandings} />
          </div>
        )}
      </section>
    )}

    <!-- C. Archive -->
    {sortedArchiveYears.length > 0 && (
      <section class="mb-16">
        <h2 class="text-xl font-medium text-foreground mb-6">
          <span class="label text-muted mr-2">[archive]</span>
        </h2>
        {sortedArchiveYears.map(({ year, seasons }) => (
          <details class="mb-4 border border-border">
            <summary class="px-4 py-3 cursor-pointer text-foreground font-medium hover:bg-surface/50 transition-colors">
              {year}
            </summary>
            <div class="px-4 pb-4 pt-2 space-y-6">
              {seasons.map(({ seasonKey, schedule, standings }) => {
                const bcGames = schedule.filter((g: UlaxGameSerialized) => g.isBarbaryCoast);
                return (
                  <div>
                    <h4 class="text-sm font-medium text-muted mb-3 uppercase tracking-wide">
                      {formatSeasonLabel(seasonKey)}
                    </h4>
                    {bcGames.length > 0 && (
                      <div class="mb-4">
                        <ScheduleList ulaxGames={bcGames} barbaryCoastOnly={true} />
                      </div>
                    )}
                    {standings.length > 0 && (
                      <Standings standings={standings} />
                    )}
                  </div>
                );
              })}
              {archiveCalByYear.has(year) && (
                <div>
                  <h4 class="text-sm font-medium text-muted mb-3 uppercase tracking-wide">
                    Events
                  </h4>
                  <ScheduleList calendarEvents={archiveCalByYear.get(year)} />
                </div>
              )}
            </div>
          </details>
        ))}
      </section>
    )}

    <!-- Footer -->
    <footer
      class="flex items-center justify-between pt-8 border-t border-border"
    >
      <p class="text-sm text-subtle">
        Updated {
          fetchedAt.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric",
          })
        }
      </p>
      <p class="text-sm text-subtle">
        Data from <a
          href="https://ulax.org/sanfrancisco/men/"
          target="_blank"
          rel="noopener"
          class="text-powder hover:underline">ulax.org</a
        >
      </p>
    </footer>
  </div>
</Layout>
